<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ­íšŒ í‘œê²° ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Thin.woff2') format('woff2');
            font-weight: 100;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-ExtraLight.woff2') format('woff2');
            font-weight: 200;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Light.woff2') format('woff2');
            font-weight: 300;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Regular.woff2') format('woff2');
            font-weight: 400;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Medium.woff2') format('woff2');
            font-weight: 500;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-SemiBold.woff2') format('woff2');
            font-weight: 600;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Bold.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-ExtraBold.woff2') format('woff2');
            font-weight: 800;
            font-display: swap;
        }

        @font-face {
            font-family: 'Pretendard';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/pretendard@1.0/Pretendard-Black.woff2') format('woff2');
            font-weight: 900;
            font-display: swap;
        }

        body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background-color: #000;
        }
        .vote-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
            gap: 8px 4px;
        }
        .vote-circle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 4px;
        }
        .status-aye { background-color: #22c55e; }
        .status-nay { background-color: #ef4444; }
        .status-abstain { background-color: #f59e0b; }
        .status-absent { background-color: #4b5563; }
        .screen { display: none; }
        .screen.active { 
            display: flex; /* Use flex for centering */
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #announcement-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            z-index: 9999;
        }
        #results-chart-container {
            width: 100%;
            max-width: 400px;
            margin: auto;
        }
        /* Dropdown transition */
        #export-dropdown {
            transition: all 0.2s ease-in-out;
            transform-origin: top right;
        }
        #export-dropdown.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            display: block; /* keep layout but hide visually to animate */
            visibility: hidden;
        }
        #export-dropdown:not(.hidden) {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="w-full h-screen">

        <!-- Screen 1: Setup -->
        <div id="setup-screen" class="screen active w-full max-w-3xl p-6 mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-sky-400 mb-2">í‘œê²° ì‹œë®¬ë ˆì´ì…˜ [v2]</h1>
                <p class="text-slate-400">ì§€ê¸ˆë¶€í„° í‘œê²°ì„ ì˜ˆì¸¡í•˜ê±°ë‚˜ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ í•´ë³´ì„¸ìš”!</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="bill-title-input" class="block text-lg font-medium text-slate-300 mb-2">ë²•ì•ˆëª…</label>
                    <textarea id="bill-title-input" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <h3 class="text-lg font-semibold">ì •ë‹¹ ë° ì˜ì„ìˆ˜</h3>
                        <p class="text-xs text-gray-500 text-right">
                            íŒŒì¼ í˜•ì‹: ì •ë‹¹ëª…, ì˜ì„ìˆ˜, ë‹¹ë¡ ì½”ë“œ, ì´íƒˆë¥ <br>
                            (ë‹¹ë¡ ì½”ë“œ: aye, nay, abstain, boycott, partial_boycott_aye ë“±)
                        </p>
                    </div>
                    
                    <div id="party-list-editor" class="space-y-2 mb-4 bg-slate-900 p-4 rounded-lg border border-slate-700 max-h-60 overflow-y-auto">
                        <!-- Party editor rows go here -->
                    </div>
                    <div class="flex justify-end gap-2 items-start">
                         <input type="file" id="party-file-input" accept=".csv,.txt" class="hidden">
                         <button id="import-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm">ğŸ“‚ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                         
                         <!-- Export Dropdown -->
                         <div class="relative inline-block text-left">
                            <button id="export-menu-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center">
                                ğŸ’¾ ëª©ë¡ ì €ì¥
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="export-dropdown" class="hidden absolute right-0 mt-2 w-32 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                    <button id="export-txt-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">TXTë¡œ ì €ì¥</button>
                                    <button id="export-csv-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">CSVë¡œ ì €ì¥</button>
                                </div>
                            </div>
                         </div>

                         <button id="add-party-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">+ ì •ë‹¹ ì¶”ê°€</button>
                    </div>
                </div>
                <button id="start-simulation-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-8 rounded-lg text-xl transition shadow-lg">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
            </div>
        </div>
        
        <!-- Screen 1.5: Bill Announcement -->
        <div id="announcement-screen" class="screen">
            <h1 id="announcement-title" class="text-4xl lg:text-5xl font-bold text-center text-white p-8"></h1>
        </div>

        <!-- Screen 2: Voting -->
        <div id="voting-screen" class="screen max-w-screen-2xl mx-auto w-full h-full p-4">
            <div class="bg-gray-900/80 border border-gray-700 p-4 sm:p-6 rounded-lg shadow-2xl shadow-sky-500/10 w-full h-full flex flex-col">
                <header class="text-center mb-4">
                    <h1 id="display-bill-title" class="text-2xl sm:text-3xl font-bold text-sky-400"></h1>
                </header>
                <div class="flex justify-center items-center flex-wrap gap-x-4 gap-y-2 bg-slate-900/50 border border-slate-700 p-3 rounded-md text-center mb-4 text-lg">
                    <div class="flex items-center">
                        <span class="text-slate-300 mr-2">ì¬ì </span>
                        <span id="count-total" class="font-bold text-white">0</span>
                        <span class="text-slate-400 ml-1">ì¸</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-slate-300 mr-2">ì¬ì„</span>
                        <span id="count-present" class="font-bold text-white">0</span>
                        <span class="text-slate-400 ml-1">ì¸</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-green-400 mr-2">ì°¬ì„±</span>
                        <span id="count-aye" class="font-bold text-green-400">0</span>
                        <span class="text-green-400 ml-1">ì¸</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-red-400 mr-2">ë°˜ëŒ€</span>
                        <span id="count-nay" class="font-bold text-red-400">0</span>
                        <span class="text-red-400 ml-1">ì¸</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-amber-400 mr-2">ê¸°ê¶Œ</span>
                        <span id="count-abstain" class="font-bold text-amber-400">0</span>
                        <span class="text-amber-400 ml-1">ì¸</span>
                    </div>
                </div>
                <div class="bg-black/30 p-4 rounded-lg flex-grow overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                        <div id="member-grid-col1" class="vote-grid"></div>
                        <div id="member-grid-col2" class="vote-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Screen 3: Results -->
        <div id="results-screen" class="screen w-full max-w-5xl p-6 mx-auto">
             <div class="w-full bg-gray-900/80 border border-gray-700 p-6 rounded-lg">
                <h1 id="results-bill-title" class="text-2xl font-bold text-center mb-4"></h1>
                <div class="flex justify-center items-center flex-wrap gap-x-4 gap-y-2 bg-slate-900/50 border border-slate-700 p-3 rounded-md text-center mb-6 text-lg">
                    <div class="flex items-center">
                        <span class="text-slate-300 mr-2">ì¬ì </span>
                        <span id="results-total" class="font-bold text-white">0</span>
                        <span class="text-slate-400 ml-1">ì¸</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-slate-300 mr-2">ì´íˆ¬í‘œ</span>
                        <span id="results-present" class="font-bold text-white">0</span>
                        <span class="text-slate-400 ml-1">í‘œ</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-green-400 mr-2">ì°¬ì„±</span>
                        <span id="results-aye" class="font-bold text-green-400">0</span>
                        <span class="text-green-400 ml-1">í‘œ</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-red-400 mr-2">ë°˜ëŒ€</span>
                        <span id="results-nay" class="font-bold text-red-400">0</span>
                        <span class="text-red-400 ml-1">í‘œ</span>
                    </div>
                    <div class="h-5 w-px bg-slate-600"></div>
                    <div class="flex items-center">
                        <span class="text-amber-400 mr-2">ê¸°ê¶Œ</span>
                        <span id="results-abstain" class="font-bold text-amber-400">0</span>
                        <span class="text-amber-400 ml-1">í‘œ</span>
                    </div>
                </div>
                <div id="results-chart-container">
                    <canvas id="results-chart"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-6 text-center text-lg">
                    <div class="text-green-400">
                        <p class="font-bold">ì°¬ì„±</p>
                        <p id="results-aye-percent">0.00%</p>
                    </div>
                    <div class="text-red-400">
                        <p class="font-bold">ë°˜ëŒ€</p>
                        <p id="results-nay-percent">0.00%</p>
                    </div>
                    <div class="text-amber-400">
                        <p class="font-bold">ê¸°ê¶Œ</p>
                        <p id="results-abstain-percent">0.00%</p>
                    </div>
                </div>
                <div class="text-center">
                    <button id="restart-btn" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition">ë‹¤ì‹œ ì‹œì‘</button>
                </div>
             </div>
        </div>

    </div>

    <script type="module">
        const app = {
            state: {
                currentScreen: 'setup',
                billTitle: 'í…ŒìŠ¤íŠ¸ ì•ˆê±´',
                parties: [],
                members: [],
                voteInProgress: false,
                voteResults: {},
                chart: null
            },

            init() {
                this.cacheDOM();
                this.bindEvents();
                this.loadInitialParties();
                this.render();
            },

            cacheDOM() {
                this.dom = {
                    screens: {
                        setup: document.getElementById('setup-screen'),
                        announcement: document.getElementById('announcement-screen'),
                        voting: document.getElementById('voting-screen'),
                        results: document.getElementById('results-screen'),
                    },
                    billTitleInput: document.getElementById('bill-title-input'),
                    announcementTitle: document.getElementById('announcement-title'),
                    partyListEditor: document.getElementById('party-list-editor'),
                    addPartyBtn: document.getElementById('add-party-btn'),
                    importBtn: document.getElementById('import-btn'),
                    exportMenuBtn: document.getElementById('export-menu-btn'),
                    exportDropdown: document.getElementById('export-dropdown'),
                    exportTxtBtn: document.getElementById('export-txt-btn'),
                    exportCsvBtn: document.getElementById('export-csv-btn'),
                    partyFileInput: document.getElementById('party-file-input'),
                    startSimulationBtn: document.getElementById('start-simulation-btn'),
                    restartBtn: document.getElementById('restart-btn'),
                    displayBillTitle: document.getElementById('display-bill-title'),
                    memberGridCol1: document.getElementById('member-grid-col1'),
                    memberGridCol2: document.getElementById('member-grid-col2'),
                    counts: {
                        total: document.getElementById('count-total'),
                        present: document.getElementById('count-present'),
                        aye: document.getElementById('count-aye'),
                        nay: document.getElementById('count-nay'),
                        abstain: document.getElementById('count-abstain'),
                    },
                    resultsBillTitle: document.getElementById('results-bill-title'),
                    resultsChart: document.getElementById('results-chart').getContext('2d'),
                    resultsTotal: document.getElementById('results-total'),
                    resultsPresent: document.getElementById('results-present'),
                    resultsAye: document.getElementById('results-aye'),
                    resultsNay: document.getElementById('results-nay'),
                    resultsAbstain: document.getElementById('results-abstain'),
                    resultsAyePercent: document.getElementById('results-aye-percent'),
                    resultsNayPercent: document.getElementById('results-nay-percent'),
                    resultsAbstainPercent: document.getElementById('results-abstain-percent'),
                };
            },

            bindEvents() {
                this.dom.addPartyBtn.addEventListener('click', () => this.addParty());
                this.dom.importBtn.addEventListener('click', () => this.dom.partyFileInput.click());
                
                // Export Menu Logic
                this.dom.exportMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.dom.exportDropdown.classList.toggle('hidden');
                });
                this.dom.exportTxtBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.exportParties('txt');
                    this.dom.exportDropdown.classList.add('hidden');
                });
                this.dom.exportCsvBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.exportParties('csv');
                    this.dom.exportDropdown.classList.add('hidden');
                });
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.dom.exportMenuBtn.contains(e.target) && !this.dom.exportDropdown.contains(e.target)) {
                        this.dom.exportDropdown.classList.add('hidden');
                    }
                });

                this.dom.partyFileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.dom.partyListEditor.addEventListener('click', (e) => {
                    if (e.target.dataset.action === 'remove') this.removeParty(e.target.dataset.id);
                });
                this.dom.startSimulationBtn.addEventListener('click', () => this.startSimulation());
                this.dom.restartBtn.addEventListener('click', () => this.reset());
            },

            loadInitialParties() {
                this.state.parties = [
                    { id: Date.now() + 1, name: 'ë”ë¶ˆì–´ë¯¼ì£¼ë‹¹', seats: 169, stance: 'aye', defectionRate: 0.0001 },
                    { id: Date.now() + 2, name: 'êµ­ë¯¼ì˜í˜', seats: 115, stance: 'nay', defectionRate: 0.0001 },
                    { id: Date.now() + 3, name: 'ì •ì˜ë‹¹', seats: 6, stance: 'partial_boycott_aye', defectionRate: 0.0001 },
                    { id: Date.now() + 4, name: 'ë¬´ì†Œì†', seats: 8, stance: 'random', defectionRate: 1.0 },
                ];
            },

            updatePartiesFromDOM() {
                this.dom.partyListEditor.querySelectorAll('.party-row').forEach(row => {
                    const id = row.dataset.id;
                    const party = this.state.parties.find(p => p.id == id);
                    if (party) {
                        party.name = row.querySelector('[data-prop="name"]').value;
                        party.seats = parseInt(row.querySelector('[data-prop="seats"]').value) || 0;
                        party.stance = row.querySelector('[data-prop="stance"]').value;
                    }
                });
            },
            
            addParty() {
                this.updatePartiesFromDOM();
                this.state.parties.push({
                    id: Date.now(), name: 'ìƒˆ ì •ë‹¹', seats: 1, stance: 'aye', defectionRate: 0.0001,
                });
                this.renderPartyEditor();
            },
            
            removeParty(id) {
                this.updatePartiesFromDOM();
                this.state.parties = this.state.parties.filter(p => p.id != id);
                this.renderPartyEditor();
            },

            exportParties(format) {
                this.updatePartiesFromDOM();
                const content = this.state.parties.map(p =>
                    `${p.name}, ${p.seats}, ${p.stance}, ${p.defectionRate}`
                ).join('\n');

                const mimeType = format === 'csv' ? 'text/csv' : 'text/plain';
                const extension = format === 'csv' ? 'csv' : 'txt';

                const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `party_list.${extension}`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const lines = content.split(/\r?\n/);
                        const newParties = [];
                        
                        lines.forEach((line, index) => {
                            if (!line.trim()) return;
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                const name = parts[0].trim();
                                const seats = parseInt(parts[1].trim());
                                let stance = 'random';
                                let defectionRate = 0.0001;

                                if (parts.length >= 3) {
                                    const stanceCode = parts[2].trim().toLowerCase();
                                    const validStances = [
                                        'aye', 'nay', 'abstain', 'boycott',
                                        'partial_boycott_aye', 'partial_boycott_nay', 
                                        'partial_boycott_random', 'random'
                                    ];
                                    
                                    if (validStances.includes(stanceCode)) {
                                        stance = stanceCode;
                                    } else if (stanceCode === 'ì°¬ì„±') stance = 'aye';
                                    else if (stanceCode === 'ë°˜ëŒ€') stance = 'nay';
                                    else if (stanceCode === 'ê¸°ê¶Œ') stance = 'abstain';
                                    else if (stanceCode === 'ë¶ˆì°¸' || stanceCode === 'ì „ì›ë¶ˆì°¸') stance = 'boycott';
                                    else if (stanceCode === 'ììœ ') stance = 'random';
                                }

                                if (parts.length >= 4) {
                                    const rate = parseFloat(parts[3].trim());
                                    if (!isNaN(rate)) defectionRate = rate;
                                }

                                if (name && !isNaN(seats)) {
                                    newParties.push({
                                        id: Date.now() + index,
                                        name,
                                        seats,
                                        stance,
                                        defectionRate
                                    });
                                }
                            }
                        });

                        if (newParties.length > 0) {
                            this.state.parties = newParties;
                            this.renderPartyEditor();
                            alert(`${newParties.length}ê°œ ì •ë‹¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                        } else {
                            alert('íŒŒì¼ì—ì„œ ìœ íš¨í•œ ì •ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error(error);
                        alert('íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                    this.dom.partyFileInput.value = '';
                };
                reader.readAsText(file);
            },

            startSimulation() {
                this.updatePartiesFromDOM();
                this.state.billTitle = this.dom.billTitleInput.value;
                
                this.generateMembers();
                this.dom.announcementTitle.textContent = this.state.billTitle;
                this.switchScreen('announcement');
                
                setTimeout(() => {
                    this.switchScreen('voting');
                    this.startVote();
                }, 5000);
            },

            generateMembers() {
                this.state.members = [];
                this.state.parties.forEach(party => {
                    for (let i = 1; i <= party.seats; i++) {
                        this.state.members.push({
                            id: `${party.id}-${i}`, party: party.name, stance: party.stance,
                            defectionRate: party.defectionRate, status: 'absent',
                        });
                    }
                });
            },
            
            startVote() {
                if (this.state.voteInProgress || this.state.members.length === 0) return;
                this.state.voteInProgress = true;
                
                const attendanceRate = 1.0; // ì°¸ì„ë¥  100%ë¡œ ê³ ì •
                
                const membersToExclude = new Set();

                this.state.parties.forEach(party => {
                    if (party.stance.includes('boycott')) {
                        const partyMembers = this.state.members.filter(m => m.party === party.name);
                        
                        if (party.stance === 'boycott') {
                            partyMembers.forEach(m => membersToExclude.add(m.id));
                        } else if (party.stance.startsWith('partial_boycott')) {
                            const boycottRate = 0.3 + Math.random() * 0.4;
                            const membersToBoycottCount = Math.floor(party.seats * boycottRate);
                            const shuffledMembers = partyMembers.sort(() => 0.5 - Math.random());
                            
                            for (let i = 0; i < membersToBoycottCount; i++) {
                                if (shuffledMembers[i]) {
                                    membersToExclude.add(shuffledMembers[i].id);
                                }
                            }
                        }
                    }
                });
                
                const potentialAttendees = this.state.members.filter(m => !membersToExclude.has(m.id));

                const presentMembers = potentialAttendees
                    .map(m => ({ ...m, sort: Math.random() }))
                    .sort((a, b) => a.sort - b.sort)
                    .slice(0, Math.floor(potentialAttendees.length * attendanceRate));


                let voteIndex = 0;
                const voteInterval = setInterval(() => {
                    if (voteIndex >= presentMembers.length) {
                        clearInterval(voteInterval);
                        this.state.voteInProgress = false;
                        setTimeout(() => this.showResults(), 5000);
                        return;
                    }
                    
                    const memberToVote = this.state.members.find(m => m.id === presentMembers[voteIndex].id);
                    if (memberToVote) {
                        const isDefector = Math.random() < memberToVote.defectionRate;
                        let vote;
                        let votingStance = memberToVote.stance;

                        if (votingStance === 'boycott') {
                            votingStance = 'random'; 
                        } else if (votingStance === 'partial_boycott_random') {
                            votingStance = 'random';
                        } else if (votingStance === 'partial_boycott_aye') {
                            votingStance = 'aye';
                        } else if (votingStance === 'partial_boycott_nay') {
                            votingStance = 'nay';
                        }

                        if (votingStance === 'random') {
                           const roll = Math.random();
                           if(roll < 0.45) vote = 'aye';
                           else if(roll < 0.9) vote = 'nay';
                           else vote = 'abstain';
                        } else if (votingStance === 'abstain') {
                            vote = isDefector ? (Math.random() < 0.5 ? 'aye' : 'nay') : 'abstain';
                        } else { 
                           vote = isDefector ? (votingStance === 'aye' ? 'nay' : 'aye') : votingStance;
                           if (isDefector && Math.random() < 0.3) vote = 'abstain';
                        }
                        memberToVote.status = vote;
                    }
                    
                    this.renderVotingScreen();
                    voteIndex++;
                }, 20);
            },
            
            showResults() {
                const aye = this.state.members.filter(m => m.status === 'aye').length;
                const nay = this.state.members.filter(m => m.status === 'nay').length;
                const abstain = this.state.members.filter(m => m.status === 'abstain').length;
                this.state.voteResults = { aye, nay, abstain };
                
                this.switchScreen('results');
                this.renderResultsScreen();
            },
            
            reset() {
                if(this.state.chart) this.state.chart.destroy();
                this.state.chart = null;
                this.state.members = [];
                this.state.voteResults = {};
                this.switchScreen('setup');
            },

            switchScreen(screenName) {
                this.state.currentScreen = screenName;
                Object.values(this.dom.screens).forEach(screen => screen.classList.remove('active'));
                this.dom.screens[screenName].classList.add('active');
            },

            render() {
                this.renderPartyEditor();
                this.dom.billTitleInput.value = this.state.billTitle;
            },
            
            renderPartyEditor() {
                this.dom.partyListEditor.innerHTML = this.state.parties.map(p => `
                    <div class="party-row flex items-center gap-2" data-id="${p.id}">
                        <input data-prop="name" type="text" value="${p.name}" class="flex-grow bg-slate-800 border border-slate-600 rounded px-2 py-1">
                        <input data-prop="seats" type="number" value="${p.seats}" class="w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1">
                        <select data-prop="stance" class="w-48 bg-slate-800 border border-slate-600 rounded px-2 py-1">
                            <option value="aye" ${p.stance === 'aye' ? 'selected' : ''}>ì°¬ì„± ë‹¹ë¡ </option>
                            <option value="nay" ${p.stance === 'nay' ? 'selected' : ''}>ë°˜ëŒ€ ë‹¹ë¡ </option>
                            <option value="abstain" ${p.stance === 'abstain' ? 'selected' : ''}>ê¸°ê¶Œ ë‹¹ë¡ </option>
                            <option value="boycott" ${p.stance === 'boycott' ? 'selected' : ''}>ì „ì› í‘œê²° ë¶ˆì°¸</option>
                            <option value="partial_boycott_aye" ${p.stance === 'partial_boycott_aye' ? 'selected' : ''}>ì¼ë¶€ ë¶ˆì°¸ (ì°¬ì„±)</option>
                            <option value="partial_boycott_nay" ${p.stance === 'partial_boycott_nay' ? 'selected' : ''}>ì¼ë¶€ ë¶ˆì°¸ (ë°˜ëŒ€)</option>
                            <option value="partial_boycott_random" ${p.stance === 'partial_boycott_random' ? 'selected' : ''}>ì¼ë¶€ ë¶ˆì°¸ (ììœ )</option>
                            <option value="random" ${p.stance === 'random' ? 'selected' : ''}>ììœ  íˆ¬í‘œ</option>
                        </select>
                        <button data-action="remove" data-id="${p.id}" class="text-red-500 hover:text-red-400 font-bold py-1 px-2 text-xl">&times;</button>
                    </div>
                `).join('');
            },

            renderVotingScreen() {
                this.dom.displayBillTitle.textContent = this.state.billTitle;
                const total = this.state.members.length;
                const present = this.state.members.filter(m => m.status !== 'absent').length;
                const aye = this.state.members.filter(m => m.status === 'aye').length;
                const nay = this.state.members.filter(m => m.status === 'nay').length;
                const abstain = this.state.members.filter(m => m.status === 'abstain').length;

                this.dom.counts.total.textContent = total;
                this.dom.counts.present.textContent = present;
                this.dom.counts.aye.textContent = aye;
                this.dom.counts.nay.textContent = nay;
                this.dom.counts.abstain.textContent = abstain;

                const midIndex = Math.ceil(this.state.members.length / 2);
                const col1Members = this.state.members.slice(0, midIndex);
                const col2Members = this.state.members.slice(midIndex);

                const renderColumn = (members) => members.map(member => {
                    const textColorClass = member.status !== 'absent' ? 'text-green-400' : '';
                    return `
                        <div class="flex items-center gap-2">
                            <div class="vote-circle status-${member.status}"></div>
                            <span class="text-xs truncate ${textColorClass}" title="${member.party}">${member.party}</span>
                        </div>
                    `;
                }).join('');

                this.dom.memberGridCol1.innerHTML = renderColumn(col1Members);
                this.dom.memberGridCol2.innerHTML = renderColumn(col2Members);
            },

            renderResultsScreen() {
                this.dom.resultsBillTitle.textContent = this.state.billTitle;
                const { aye, nay, abstain } = this.state.voteResults;
                const totalMembers = this.state.members.length;
                const totalVotes = aye + nay + abstain;

                this.dom.resultsTotal.textContent = totalMembers;
                this.dom.resultsPresent.textContent = totalVotes;
                this.dom.resultsAye.textContent = aye;
                this.dom.resultsNay.textContent = nay;
                this.dom.resultsAbstain.textContent = abstain;
                
                this.dom.resultsAyePercent.textContent = totalVotes > 0 ? ((aye / totalVotes) * 100).toFixed(2) + '%' : '0.00%';
                this.dom.resultsNayPercent.textContent = totalVotes > 0 ? ((nay / totalVotes) * 100).toFixed(2) + '%' : '0.00%';
                this.dom.resultsAbstainPercent.textContent = totalVotes > 0 ? ((abstain / totalVotes) * 100).toFixed(2) + '%' : '0.00%';

                this.create2DChart();
            },

            create2DChart() {
                if (this.state.chart) {
                    this.state.chart.destroy();
                }
                
                const { aye, nay, abstain } = this.state.voteResults;

                this.state.chart = new Chart(this.dom.resultsChart, {
                    type: 'pie',
                    data: {
                        labels: ['ì°¬ì„±', 'ë°˜ëŒ€', 'ê¸°ê¶Œ'],
                        datasets: [{
                            data: [aye, nay, abstain],
                            backgroundColor: [
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)',
                                'rgba(245, 158, 11, 0.8)'
                            ],
                            borderColor: [
                                '#16a34a',
                                '#dc2626',
                                '#d97706'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 0
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true
                            }
                        }
                    }
                });
            }
        };

        app.init();
    </script>
</body>
</html>
